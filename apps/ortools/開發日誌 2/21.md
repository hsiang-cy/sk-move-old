# 開發日誌 (2026/02/21) - Modal.com 遷移詳盡紀錄

## 1. 今日開發背景
將原有的 **OR-Tools VRP Solver** 從傳統 FastAPI 部署模式遷移至 **Modal.com**。目標是利用其 Serverless 特性，讓求解運算（Solver）在獨立、可伸縮的雲端 Worker 中執行，並透過 FastAPI 提供異步 API 接口。

---

## 2. 代碼重構步驟

### Step 1: 環境與 Image 定義 (`src/main.py`)
- **改動**: 引入 `modal` 庫，定義 `modal.Image` (基於 Debian Slim，安裝 `ortools`, `fastapi`, `httpx`)。
- **目標**: 建立雲端執行的基礎環境鏡像。

### Step 2: 核心邏輯遷移 (`src/vrp/solver.py`)
- **改動**: 
    - 將 `solve_vrp` 邏輯封裝至 `solve_vrp_logic`。
    - **重要變更**: 將 Webhook 通知邏輯移入求解函式內部，確保在 Serverless 環境下計算結束後能立即回報結果。
- **目標**: 確保運算層具備自我回報能力。

### Step 3: API 路由重構 (`src/vrp/router.py`)
- **改動**: 移除 FastAPI 的 `BackgroundTasks`，改用 Modal 的 `solve_vrp.spawn(job_id, request)` 進行非同步任務發送。
- **目標**: 實現真・非同步（Serverless Spawn）。

---

## 3. 測試與報錯排除過程 (詳盡紀錄)

### 測試 0: 本地環境安裝與認證
- **操作**: 執行 `pip install modal` 並嘗試 `modal serve`。
- **錯誤**: `Token missing. Could not authenticate client.`
- **排除**: 執行 `modal setup` 完成瀏覽器身分驗證，成功獲取 Token 並儲存至 `~/.modal.toml`。

### 測試 1: 首次啟動服務
- **操作**: `modal serve src/main.py`。
- **執行 curl**: `POST /vrp/solve`
- **錯誤結果**: `404 Not Found`
- **診斷**: Modal 的 FastAPI 封裝 (`@modal.fastapi_endpoint`) 預設會影響路徑匹配。
- **修復**: 修改 `main.py` 確保 `include_router` 在正確的生命週期執行。

### 測試 2: 第二次請求
- **執行 curl**: `POST /vrp/solve`
- **錯誤結果**: `HTTP 303 See Other` 並導向帶有 `__modal_function_call_id` 的 URL。
- **診斷**: Modal 誤將其視為同步 Web 函式處理，而非 ASGI 應用。
- **修復**: 將裝飾器由 `@modal.fastapi_endpoint()` 更換為最新推薦的 **`@modal.asgi_app()`**。

### 測試 3: 雲端環境模組導入
- **執行 curl**: `POST /vrp/solve`
- **錯誤結果**: `ModuleNotFoundError: No module named 'vrp'`
- **診斷**: Modal 雲端容器內的 Python 路徑找不到 `src` 下的套件。
- **連鎖排除步驟**:
    1. 建立 `src/vrp/__init__.py` (原本缺失)。
    2. 嘗試手動掛載：使用 `mounts=[modal.Mount.from_local_dir(...)]`。
    3. 設定環境變數：`env={"PYTHONPATH": "/root/src"}`。

### 測試 4: API 版本與屬性衝突 (關鍵阻礙)
- **錯誤 A**: `AttributeError: module 'modal' has no attribute 'Mount'`。
    - 試圖修復時發現 `modal.Mount` 在此版本 (1.3.3) 無法直接訪問。
- **錯誤 B**: `AttributeError: module 'modal.mount' has no attribute 'from_local_dir'`。
    - 透過 `dir(modal.mount)` 檢查發現 API 結構與舊文檔不符。
- **錯誤 C**: `InvalidError: Class _Mount has no constructor. Use class constructor methods instead.`。
    - 最終嘗試使用 `modal.mount.Mount()` 時，被系統攔截，提示必須使用工廠方法（Factory methods）。

---

## 4. 當前代碼遺留狀態 (至暫停前)
- **`src/main.py`**: 目前嘗試使用 `modal.mount.Mount` 進行掛載，但引發了構造函數錯誤。
- **`src/vrp/solver.py`**: 已移除冗餘的 `modal.App` 定義，目前處於 Standalone 狀態，待 `main.py` 正確裝飾。
- **`src/vrp/router.py`**: 已改為使用 `modal.Function.from_name` 的動態查找模式，避免循環引用。

## 5. 待辦清單 (下次接續)
1. **查閱 Modal 1.3.3 SDK 文檔**: 確認正確的掛載語法 (可能是 `modal.Mount.from_local_dir` 的某種變體)。
2. **清理路徑結構**: 建議將專案根目錄對齊，或是乾脆將 `main.py` 放在根目錄而非 `src` 下。
3. **驗證 Webhook**: 修正路徑後，需驗證 `solve_vrp_logic` 能否成功 POST 到 Webhook.site。

---
**開發者筆記**: 本日耗費較多時間在處理雲端環境與本地 SDK 版本的 API 對齊問題。目前的邏輯已經正確拆分，僅剩環境掛載機制需要最後的細部調教。
