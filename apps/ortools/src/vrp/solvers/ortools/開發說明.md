# VRP Solver v1 — 開發說明

## 設計目標

最小可用的 VRP 求解器。優先讓整個 fire-and-forget 非同步流程跑通（HTTP 202 → Modal background task → webhook 回呼），約束條件保持最簡，讓 API 端可以盡早串接測試。

---

## 架構決策

### 為何用 OR-Tools RoutingModel 而非自己實作演算法？

VRP 是 NP-hard 問題。OR-Tools 的 RoutingModel 內建 Local Search metaheuristic（GLS、SA 等），在合理時間內能找到接近最佳解，自己實作的效果幾乎不可能更好。

### First Solution Strategy：PATH_CHEAPEST_ARC

最快找到初始解的策略，從 depot 出發每步貪婪選擇最近弧。適合作為 GLS 的起點，不需要太好的初始解，GLS 會繼續改善。

### Metaheuristic：GUIDED_LOCAL_SEARCH（GLS）

GLS 相對 TABU_SEARCH 收斂較穩定，且對時間限制（`time_limit_seconds`）的反應好——時間到就回傳當前最佳解，不會卡死。

### 時間維度的 `slack`（waiting time）設為 `max_time`

```python
routing.AddDimension(time_callback_index, max_time, max_time, False, "Time")
#                                          ^^^^^^^^
#                                          slack = max_time（允許等待）
```

允許車輛提早抵達後等到時間窗開始，這是正確行為。若設為 0，車輛無法等待，會導致不必要的 infeasible。

### 容量維度：`net demand = pickup - delivery`

每個節點的需求設計為「淨值」，這樣同一個節點可以同時裝卸，RoutingModel 只需要一個 Capacity dimension 就夠，不需要分開建模。

### 為何不在這層做 `depot_index` 驗證？

Pydantic schema 的 `field_validator` 只驗證欄位本身，`depot_index` 是否在 `locations` 範圍內需要跨欄位驗證。目前的設計是讓 OR-Tools 在建立 `RoutingIndexManager` 時自然拋出 IndexError，由 `engine.py` 的 `except Exception` 捕獲後透過 webhook 回報。這樣不需要重複驗證邏輯，但錯誤訊息對使用者不夠友善。

---

## 已知限制（設計上刻意接受）

| 限制 | 說明 |
|---|---|
| 硬性時間窗 | 任一節點的時間窗不可達 → 整個求解失敗 |
| 所有地點必訪 | 沒有 `AddDisjunction`，無法跳過地點 |
| 無路線時長上限 | 車輛可以無限行駛，不能表達「司機最多工作 N 小時」 |
| 單一 depot | `RoutingIndexManager` 只傳入一個 depot index |
| 無配對取送 | pickup/delivery 是節點屬性，不是 pair 約束 |

這些限制在 v2 中部分解決（3、4、5），其餘留待後續版本。

---

## 可改善方向

### 1. 錯誤訊息品質
`depot_index out of range`、`matrix dimension mismatch` 這類錯誤目前靠 Python/OR-Tools 拋出的訊息，不夠清楚。可在 `engine.py` 入口加前置驗證，給出中文錯誤說明。

### 2. `time_limit_seconds` 預設值
目前預設 30 秒。對小規模問題（< 10 個地點）太長，對大規模問題（> 50 個地點）太短。可考慮根據 `N²` 動態計算建議值，或在 schema 層限制合理範圍（5~300 秒）。

### 3. Solution Quality Callback
目前無法知道「solver 在 time limit 內找到的解是初始解還是改善過的解」。可用 `routing.AddAtSolutionCallback` 記錄改善過程，輸出到 log 幫助 debug 難以求解的案例。

### 4. Webhook 失敗處理
目前 webhook POST 失敗只印 log，沒有 retry。若 API server 短暫不可用（重啟中），結果就遺失了。可考慮加入指數退避重試（最多 3 次）。
